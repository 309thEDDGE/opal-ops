## Opal-Operations
---
#### Purpose

This repo contains all the deployment code and configuration files necessary for deploying Opal platform. The Opal platform consists of Jupyterhub running a custom Jupyter notebook containing TIP. Jupyterhub is also configured with an Externally-Managed Service called Opal-Catalog, which is a custom application built using React and Tornado. The Opal-Catalog application serves data from Catalog-DB stored in Postgresql. Finally, Minio is used as an 'offline bucket' to store parquet files that gets generated by TIP. To control package dependencies and manage the environment in which Jupyterhub and Opal-Catalog run in, Conda is heavily utilized and an extension of Conda called "Conda-Vendor" was created. Conda-Vendor generates local "conda channels", which contains all the necessary packages required for creating the environment in which Jupyterhub and Opal-catalog can successfully run in.

---

#### Instructions for deploying platform locally

1. Clone the opal-ops repo from https://github.com/309thEDDGE/opal-ops.git
```bash
git clone https://github.com/309thEDDGE/opal-ops.git
```
2. cd into the repo directory, and into the docker-compose directory.
```bash
cd opal-ops/docker-compose
```
3. Clone https://github.com/309thEDDGE/opal into this repository's
`docker-compose` directory
```bash
git clone https://github.com/309thEDDGE/opal
```
4. Clone https://github.com/309thEDDGE/weave into the same `docker-compose` directory. `~/opal-ops/docker-compose`
```bash
git clone https://github.com/309thEDDGE/weave
```
5. If Docker is not installed, install it via your system's package manager (e.g., apt, brew, choco) or download Docker Desktop. Have docker running when using opal.

6. Log into registry1.dso.mil on the internet.
```bash
https://registry1.dso.mil/account/sign-in
```

7. Once you are logged click your username on the top right, then click `User Profile`. Your  `Username` and `CLI secret` will be used in the next step.

8. Back in terminal log in to registry1.dso.mil with docker.
```bash
docker login registry1.dso.mil
```
When it asked for your username and password it is your `Username` and `CLI secret` respectively from the previous step.

9. cd into the configuration directory 
```bash
cd configuration
```
10. run the following in the terminal 
```bash
bash new_deployment.bash
```

> [!note]
>
> Instead of manually configuring the deployment by following step 11, the configuration can be passed a json file with options already configured.
> This is mostly useful when a deployment should be copied or configuration steps should be saved.
> To use this option, pass the full path of a json file as an argument to the `new_deployment.bash` script (`bash new_deployment.bash ~/opal-ops/docker-compose/configuration/example-options.json`).
> This file should have the same options as the example file, located at `opal-ops/docker-compose/configuration/example-options.json`.
> The file is currently configured to have the same setup as the suggestions in step 11.

11. You now have to configure your deployment with the following settings:

    **Deployment name:** 

        what ever you choose to call your local depolyment. (ex. deploy)
    **Localhost deployment (y/n)?** 

        n
    **Base DNS name of this deployment (i.e. .companyname.com)**

        .127.0.0.1.nip.io 
    **Add opal to base URL? (y,n)**

        n
    **Banner color (Looks like classification banner, must be HTML color):**

        this can be any color to the user's preference green, blue, red, etc. (ex. red)
    **Banner name (Can be used for network name or classification markings)**

        this can be any text according the the preference of the user (ex. classification).
    **Deploy keycloak with OPAL (y/n)**

        y
> [!note]
>
> Always choose y, unless you are an expert with OPAL and have an external keycloak deployment.
12. After the configuration is complete go back into the docker-compose directory.
```bash
cd ..
```

13. Now you should see a bash script from whatever name you called the deployment. (ex. deploy_util.sh)
14. Open `~/opal-ops/docker-compose/.env` and change
```bash
IB_SINGLEUSER_IMAGE=registry1.dso.mil/ironbank/opensource/metrostar/pytorch:cuda_v7
```
to 
```bash
IB_SINGLEUSER_IMAGE=registry1.dso.mil/ironbank/opensource/metrostar/pytorch:cuda_v3
```
15. run the script as 'bash <name_of_deployment>_util.sh start
> [!note]
>
> In general, it will be necessary to run the start script with admin privileges ```sudo``` at the start of a bash command. This can be circumvented if docker is set up in certain ways and if certain files under `access_logs` have their ownership modified, but these workarounds should be avoided.
```bash
bash deploy_util.sh start
```

16. this script will download all the appropriate packages and complete the installation process for OPAL. This takes a while (little over an hour, maybe 1.5 hours, with the launch pad internet)
---

#### Adding other users to the deployment

The url pattern for keycloak is `keycloak.<domain>/auth`

Keycloak has a root user and password. These may be obtained as necessary by the admin of the deployment.

Go to the below url to add other users to the deployment
```
keycloak.127.0.0.1.nip.io
```

Log in with the root credentials
```
user: admin
pass: opal
```

To add a user perform the following:

- click `Administration Console` (you may automatically be redirected without this step `https://keycloak.127.0.0.1.nip.io/auth/admin/master/console/`)

The url would be
```
https://keycloak.127.0.0.1.nip.io/auth/admin/master/console/
```

- click `Users` (on the left side under the `Manage` section)
- click `Add User` button in the `Users` section (should be in the center of the screen)
- create a username, click `Create`.

After the user is generated, the following steps are performed within the user configuration. If this is not automatically pulled up, it can be accessed by clicking `Users` on the left bar, searching for the username, and clicking the blue UID for the user:


To allow Minio access:
- click `Groups` on the left side
- click `jupyterhub_staff` in the middle third section (if the window takes the full screen)
- click `Attributes` under `jupyterhub_staff`.
- add the key: `policy` and the value: `consoleAdmin`
- click `Save`. 
  - for less permissive policies see [the minio documentation](https://docs.min.io/minio/baremetal/security/minio-identity-management/policy-based-access-control.html). Ensure `Add` and then `Save` are clicked, otherwise jupyterhub will show a `500: internal Server Error` when the user attempts login
- click `Users` under the `Manage` section
- click the user (the blue uid) you just made
- click `Groups` in the center sectino under your new user
- click `Join Group`, and check `jupyterhub_staff` to allow the user to log into jupyterhub
- click the `Credentials` tab under your new user (middle of screen)
- click `Set password` button
- add a temporary password in the `Password` and `Password Comfirmation` fields
  - this should send the username and temporary password to the user

The user should now be able to log into jupyterhub.

https://opal.127.0.0.1.nip.io/hub/


Tips:

- Make sure your docker desktop is running.

- You might need to clear cache or cookies or open jupyterhub in incognito mode.


#### Instructions for updating base image tags

The `opal-ops/docker-compose/.env` file holds all the references to the base image
tags. To update any of the tags in acceptance, change the tags in this
file and create a Merge Request. An example for updating the tip image is below.

Tag:
```
SINGLE_USER_TIP_IMAGE=registry.il2.dso.mil/skicamp/project-opal/tip:a599b7c2
...
```

New tag:
```
SINGLE_USER_TIP_IMAGE=registry.il2.dso.mil/skicamp/project-opal/tip:b249b7d1
...
```

Create the merge request in a new branch, and then message the ops
team in the `acceptance` channel with a link to the Merge Request.


#### URLs for local dev

- https://minio.127.0.0.1.nip.io/login
- https://keycloak.127.0.0.1.nip.io/auth
- https://opal.127.0.0.1.nip.io/hub/

NOTE: If the links above do not resolve then you will need to modify your hosts file and have 
`minio.127.0.0.1.nip.io`, `jupyterhub.127.0.0.1.nip.io`, `keycloak.127.0.0.1.nip.io` resolve to localhost.

To do this go to
- ```C:\Windows\System32\drivers\etc```
- edit the `hosts` file (ex. using notepad running as adminstrator)
- at the bottom of the file add
```
    # Added keycloak to resolve to local host
    127.0.0.1 https://minio.127.0.0.1.nip.io/login
    127.0.0.1 https://keycloak.127.0.0.1.nip.io/auth
    127.0.0.1 https://opal.127.0.0.1.nip.io/hub/
```

##### Credentials for websites

The admin user credentials for keycloak:

```
user: admin
pass: opal
```

The user login for jupyterhub:

```
user: opaluser
pass: opalpassword
```

#### Start and Stop Opal
To start Opal again

- make sure docker is running
- bash <name_of_deployment>_util.sh start in the docker-compose folder 
- ```bash
  bash deploy_util.sh start
  ```
> [!note]
> 
> This could take several minutes to start again, depending on the resources the computer has available.

To stop Opal

- bash <name_of_deployment>_util.sh stop
- ```bash
  bash deploy_util.sh stop
  ```

#### Release format

Releases follow the format `YYYY.MM.DD`.
If a second tag is created in the same day, append with `YYYY.MM.DD_v2`, `YYYY.MM.DD_v3` etc

Do the following to create a tag in the github GUI for opal-ops:

- click `code` 
- click `Releases`
- click `Draft a new release` in the upper right
- add notes in the "release notes" (not messages)

#### Contributing

Prior to pushing any commits to this repository , enable the Trufflehog pre-commit hook with 
```
sudo apt install pre-commit
pre-commit install
``` 
from the root of this repository  `~/opal-ops`. This will require a working install of docker and [pre-commit](https://pre-commit.com/)
```bash
pip install pre-commit
```

#### Testing the update_deployment.bash

In order to use the `overwrite_files` function located within the `update_deployment.bash`, you need to ensure the function is uncommented in the `main()`
and have `deepDiff` installed locally 
```bash
pip install deepdiff
```

#### Troubleshooting guide
##### Troubleshoot docker login
###### Update Certs
If installroot is not installed already, it can be found from the below URL 
https://public.cyber.mil/pki-pke/end-users/getting-started/#toggle-id-1
Run installroot as administrator and "Install Certs"

##### Troubleshoot deployment
May need to remove old docker volume before redeploying 
`docker volume rm opal_postgres_storage` 
Write the docker logs to a txt file and look through errors
`docker-compose logs > logs.txt`